{% extends 'layout.html' %}

{% block content %}
<div class="container py-5">
    <h1 class="mb-4">Edit Image</h1>
    
    <div class="row">
        <div class="col-md-6">
            <img src="{{ url_for('static', filename='images/' + image.filename) }}" 
                 class="img-fluid mb-3">
        </div>
        <div class="col-md-6">
            <form method="POST" action="{{ url_for('update_image', image_id=image.id) }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                <div class="mb-3">
                    <label class="form-label">Description</label>
                    <textarea name="description" class="form-control" rows="3" maxlength="500" oninput="countChars()">{{ image.description or '<i>No Description</i>' }}</textarea>
                    <div class="text-muted text-end">
                        <span id="charCount">{{ image.description|length if image.description else 0 }}</span>/500
                    </div>
                </div>
                
                <button type="submit" class="btn btn-primary">Save Changes</button>
                <a href="{{ url_for('gallery') }}" class="btn btn-outline-secondary">Cancel</a>
            </form>
        </div>
    </div>
</div>

<div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5>Tags</h5>
        <small class="text-muted tag-counter">
            <span id="currentTagCount">{{ image.tags|length }}</span>/8 tags
        </small>
    </div>
    <div class="card-body">
        <!-- Current Tags -->
        <div class="mb-3" id="currentTags">
            {% for tag in image.tags %}
            <span class="badge bg-primary me-2 mb-2">
                {{ tag.name }}
                <button type="button" class="btn-close btn-close-white ms-1" 
                        onclick="removeTag({{ image.id }}, {{ tag.id }})"></button>
            </span>
            {% endfor %}
        </div>

        <!-- Tag Input -->
        <div class="input-group mb-3">
            <input type="text" id="newTagInput" class="form-control" 
                   placeholder="New tag (max 20 chars)" maxlength="20">
            <button class="btn btn-primary" type="button" id="addTagBtn">Add</button>
        </div>

        <!-- Suggestions -->
        {% if all_tags %}
        <div class="mt-3">
            <h6>Existing Tags</h6>
            <div class="d-flex flex-wrap gap-2" id="suggestedTags">
                {% for tag in all_tags %}
                {% if tag not in image.tags %}
                <button type="button" class="btn btn-sm btn-outline-secondary tag-suggestion"
                        onclick="addTag({{ image.id }}, {{ tag.id }}, '{{ tag.name }}')">
                    {{ tag.name }}
                </button>
                {% endif %}
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// CSRF token for AJAX requests
const csrfToken = document.querySelector('input[name="csrf_token"]').value;

// Update tag count display
function updateTagCount() {
    const count = document.querySelectorAll('#currentTags .badge').length;
    document.getElementById('currentTagCount').textContent = count;
    
    if (count >= 8) {
        document.getElementById('newTagInput').disabled = true;
        document.getElementById('addTagBtn').disabled = true;
        document.getElementById('newTagInput').placeholder = "Maximum tags reached";
    } else {
        document.getElementById('newTagInput').disabled = false;
        document.getElementById('addTagBtn').disabled = false;
        document.getElementById('newTagInput').placeholder = "New tag (max 20 chars)";
    }
}

// Add tag from input
document.getElementById('addTagBtn').addEventListener('click', async function() {
    const tagName = document.getElementById('newTagInput').value.trim();
    const imageId = {{ image.id }};
    
    if (!tagName) return;
    if (tagName.length > 20) {
        alert("Tag must be 20 characters or less");
        return;
    }
    
    await addNewTag(imageId, tagName);
    document.getElementById('newTagInput').value = '';
});

// Add existing tag
async function addTag(imageId, tagId, tagName) {
    try {
        const response = await fetch(`/add_tag/${imageId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json',  // Explicitly ask for JSON
                'X-CSRF-Token': csrfToken
            },
            body: JSON.stringify({ tag: tagName })
        });

        // First check if response is JSON
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            const text = await response.text();
            throw new Error(`Expected JSON, got: ${text.slice(0, 100)}...`);
        }

        const data = await response.json();
        
        if (!response.ok) {
            throw new Error(data.error || `Server error: ${response.status}`);
        }
        
        addTagToUI(data.tag_id, data.tag);
    } catch (error) {
        console.error('Add tag failed:', error);
        alert(`Error: ${error.message}`);
    }
}


// Add new tag (creates tag first)
async function addNewTag(imageId, tagName) {
    try {
        console.log("Attempting to add tag:", tagName);
        
        const response = await fetch(`/add_tag/${imageId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json',
                'X-CSRF-Token': csrfToken
            },
            body: JSON.stringify({ tag: tagName })
        });

        // Check if response is JSON
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            const text = await response.text();
            throw new Error(`Server returned: ${text}`);
        }

        const data = await response.json();
        
        if (!response.ok) {
            throw new Error(data.error || "Failed to add tag");
        }
        
        console.log("Tag added successfully:", data);
        addTagToUI(data.tag_id, data.tag);
    } catch (error) {
        console.error("Error adding tag:", error);
        alert(`Error: ${error.message}`);
    }
}

// Remove tag
async function removeTag(imageId, tagId) {
    if (!confirm("Remove this tag?")) return;
    
    try {
        const response = await fetch(`/api/tags/${tagId}`, {
            method: 'DELETE',
            headers: {
                'X-CSRF-Token': csrfToken
            }
        });
        
        if (response.ok) {
            // Remove from current tags
            document.querySelector(`#currentTags button[onclick*="${tagId}"]`).closest('.badge').remove();
            
            // Re-enable in suggestions
            const tagName = document.querySelector(`#currentTags button[onclick*="${tagId}"]`)?.closest('.badge')?.textContent.trim();
            if (tagName) {
                const suggestions = document.getElementById('suggestedTags');
                const buttons = suggestions.querySelectorAll('button');
                buttons.forEach(btn => {
                    if (btn.textContent.trim() === tagName) {
                        btn.disabled = false;
                        btn.classList.remove('disabled', 'text-muted');
                        btn.classList.add('btn-outline-secondary');
                    }
                });
            }
            
            updateTagCount();
        } else {
            const error = await response.json();
            alert(error.message || "Failed to remove tag");
        }
    } catch (error) {
        console.error("Error removing tag:", error);
        alert("Network error");
    }
}

// Add tag to UI
function addTagToUI(tagId, tagName) {
    // Add to current tags
    const currentTags = document.getElementById('currentTags');
    const badge = document.createElement('span');
    badge.className = 'badge bg-primary me-2 mb-2';
    badge.innerHTML = `${tagName} <button type="button" class="btn-close btn-close-white ms-1" 
                     onclick="removeTag(${image.id}, ${tagId})"></button>`;
    currentTags.appendChild(badge);
    
    // Remove from suggestions
    const suggestions = document.getElementById('suggestedTags');
    const button = suggestions.querySelector(`button[onclick*="${tagId}"]`);
    if (button) {
        button.disabled = true;
        button.classList.add('disabled');
        button.classList.remove('btn-outline-secondary');
        button.classList.add('text-muted');
    }
    
    updateTagCount();
}

// Initialize tag count
updateTagCount();

function countChars() {
    const textarea = document.querySelector('textarea[name="description"]');
    const counter = document.getElementById('charCount');
    counter.textContent = textarea.value.length;
    
    // Optional: Add warning at 400 characters
    if (textarea.value.length >= 400) {
        counter.classList.add('text-warning');
    } else {
        counter.classList.remove('text-warning');
    }
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', countChars);

</script>
{% endblock %}