{% extends 'layout.html' %}

{% block content %}
<div class="container mt-5">
    <h1 class="mb-4">Image Uploader</h1>
    
    <!-- Drag and Drop Zone -->
    <div id="dragDropArea" class="drag-drop-area border rounded p-5 text-center mb-4">
        <div class="drop-instructions">
            <i class="bi bi-cloud-arrow-up display-4 text-muted"></i>
            <h4>Drag & Drop Images Here</h4>
            <p class="text-muted">or</p>
            <button id="browseFilesBtn" class="btn btn-primary">Browse Files</button>
            <input type="file" id="fileInput" class="d-none" multiple accept=".jpg,.jpeg,.png,.gif">
        </div>
        <div class="drop-preview d-none">
            <div class="alert alert-info">
                <i class="bi bi-check-circle"></i> <span id="fileCount">0</span> files ready for upload
            </div>
            <div id="filePreviews" class="d-flex flex-wrap gap-2 mt-3"></div>
        </div>
    </div>

    <!-- Upload Form -->
    <form id="uploadForm" method="POST" enctype="multipart/form-data">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
        <div id="fileList"></div>
        
        <div class="d-flex gap-2 mt-3">
            <button type="submit" id="uploadBtn" class="btn btn-success">
                <i class="bi bi-upload"></i> Upload All Files
            </button>
            <button type="button" id="clearBtn" class="btn btn-danger">
                <i class="bi bi-x-circle"></i> Clear All
            </button>
        </div>
    </form>

    <!-- Uploaded Images Section -->
    <div class="mt-5">
        <h2>Uploaded Images</h2>
        <div id="uploadedImages" class="row mt-3">
            {% for image in images %}
            <div class="col-md-4 col-lg-3 mb-4">
                <div class="card h-100">
                    <img src="{{ url_for('static', filename='images/' + image.filename) }}" 
                         class="card-img-top" 
                         alt="{{ image.filename }}"
                         data-bs-toggle="modal" 
                         data-bs-target="#imageModal">
                    <div class="card-body">
                        <h5 class="card-title">{{ image.filename }}</h5>
                        <div class="tags mb-2">
                            {% for tag in image.tags %}
                            <span class="badge bg-secondary">{{ tag.name }}</span>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Image Preview Modal -->
<div class="modal fade" id="imageModal" tabindex="-1">
    <!-- Modal content here (same as before) -->
</div>

<!-- All JavaScript self-contained in the template -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Elements
    const dragDropArea = document.getElementById('dragDropArea');
    const fileInput = document.getElementById('fileInput');
    const browseFilesBtn = document.getElementById('browseFilesBtn');
    const uploadForm = document.getElementById('uploadForm');
    const uploadBtn = document.getElementById('uploadBtn');
    const clearBtn = document.getElementById('clearBtn');
    const filePreviews = document.getElementById('filePreviews');
    const fileCount = document.getElementById('fileCount');
    const dropInstructions = document.querySelector('.drop-instructions');
    const dropPreview = document.querySelector('.drop-preview');

    let files = [];

    // Event Listeners
    if (browseFilesBtn && fileInput) {
        browseFilesBtn.addEventListener('click', () => fileInput.click());
    }

    if (fileInput) {
        fileInput.addEventListener('change', handleFileSelect);
    }

    if (dragDropArea) {
        dragDropArea.addEventListener('dragover', handleDragOver);
        dragDropArea.addEventListener('dragleave', handleDragLeave);
        dragDropArea.addEventListener('drop', handleDrop);
    }

    if (clearBtn) {
        clearBtn.addEventListener('click', clearAllFiles);
    }

    if (uploadForm) {
        uploadForm.addEventListener('submit', handleFormSubmit);
    }

    // Functions
    function handleFileSelect(event) {
        const newFiles = Array.from(event.target.files);
        files = [...files, ...validateFiles(newFiles)];
        updateFileDisplay();
    }

    function validateFiles(fileList) {
        return fileList.filter(file => {
            const validTypes = ['image/jpeg', 'image/png', 'image/gif'];
            const maxSize = 16 * 1024 * 1024; // 16MB
            
            if (!validTypes.includes(file.type)) {
                showAlert(`Skipped ${file.name}: Invalid file type`, 'warning');
                return false;
            }
            
            if (file.size > maxSize) {
                showAlert(`Skipped ${file.name}: File too large (max 16MB)`, 'warning');
                return false;
            }
            
            return true;
        });
    }

    function handleDragOver(e) {
        e.preventDefault();
        dragDropArea.classList.add('drag-over');
    }

    function handleDragLeave() {
        dragDropArea.classList.remove('drag-over');
    }

    function handleDrop(e) {
        e.preventDefault();
        dragDropArea.classList.remove('drag-over');
        if (e.dataTransfer.files.length) {
            handleFileSelect({ target: { files: e.dataTransfer.files } });
        }
    }

    function updateFileDisplay() {
        if (files.length === 0) {
            dropInstructions.classList.remove('d-none');
            dropPreview.classList.add('d-none');
            return;
        }
        
        dropInstructions.classList.add('d-none');
        dropPreview.classList.remove('d-none');
        fileCount.textContent = files.length;
        
        filePreviews.innerHTML = '';
        files.forEach((file, index) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                const preview = document.createElement('div');
                preview.className = 'file-preview';
                preview.innerHTML = `
                    <div class="position-relative">
                        <img src="${e.target.result}" class="img-thumbnail" style="height: 100px;">
                        <button class="btn btn-danger btn-sm position-absolute top-0 end-0 m-1 remove-file" 
                                data-index="${index}">
                            <i class="bi bi-x"></i>
                        </button>
                        <div class="small text-truncate mt-1">${file.name}</div>
                    </div>
                `;
                filePreviews.appendChild(preview);
            };
            reader.readAsDataURL(file);
        });
    }

    function clearAllFiles() {
        files = [];
        updateFileDisplay();
    }

    async function handleFormSubmit(e) {
    e.preventDefault();
    
    if (files.length === 0) {
        showAlert('Please select at least one file', 'warning');
        return;
    }
    
    const formData = new FormData();
    files.forEach(file => {
        formData.append('images', file);
    });
    
    uploadBtn.disabled = true;
    uploadBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Uploading...';
    
    try {
        const response = await fetch("{{ url_for('api_upload') }}", {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRF-Token': "{{ csrf_token() }}"
            }
        });

        // First check if response is JSON
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            throw new Error('Server returned non-JSON response');
        }

        const result = await response.json();
        
        if (!response.ok) {
            throw new Error(result.error || 'Upload failed');
        }
        
        // Success - reload page to show new uploads
        window.location.reload();
        
    } catch (error) {
        console.error('Upload error:', error);
        showAlert(`Upload failed: ${error.message}`, 'danger');
    } finally {
        uploadBtn.disabled = false;
        uploadBtn.innerHTML = '<i class="bi bi-upload"></i> Upload All Files';
    }
}

    function showAlert(message, type) {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show mt-3`;
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.querySelector('.container').prepend(alertDiv);
        
        setTimeout(() => {
            alertDiv.classList.remove('show');
            setTimeout(() => alertDiv.remove(), 150);
        }, 5000);
    }

    // Remove file handler
    document.addEventListener('click', function(e) {
        if (e.target.closest('.remove-file')) {
            const index = parseInt(e.target.closest('.remove-file').getAttribute('data-index'));
            files.splice(index, 1);
            updateFileDisplay();
        }
    });
});
</script>

<style>
.drag-drop-area {
    border: 2px dashed #ccc;
    transition: all 0.3s;
    background-color: #f8f9fa;
}
.drag-drop-area.drag-over {
    border-color: #0d6efd;
    background-color: rgba(13, 110, 253, 0.05);
}
.file-preview {
    width: 120px;
}
</style>
{% endblock %}