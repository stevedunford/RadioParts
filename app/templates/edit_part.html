{% extends 'layout.html' %}

{% block content %}

<form id="part-form" class="art-deco-form">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    <input type="hidden" name="part_id" value="{{ part.id }}">

    <!-- Name/Description Fields -->
    <div class="form-group">
        <label for="name">Part Name</label>
        <input type="text" id="name" name="name" 
               maxlength="100" placeholder="" value="{{ part.name }}">
    </div>
    <div class="form-group">
        <label for="part_number">Part Number</label>
        <input type="text" id="part_number" name="part_number" 
               maxlength="30" placeholder="if known, e.g. R6301" value="{{ part.part_number }}">
    </div>

    <!-- Image Upload/Display -->
    <div class="dropzone" id="dropzone">
        <div class="dropzone-content">
            <i class="fas fa-cloud-upload-alt dropzone-icon"></i>
            <h3 class="dropzone-title">Update Part Photos</h3>
            <p class="dropzone-subtitle">Drag & drop UP TO 8 images here or</p>
            <span class="dropzone-browse" id="browseBtn">Browse Files</span>
            <p class="dropzone-file-info">Supports JPG, PNG and GIF up to 16MB each</p>
        </div>

        <div class="dz-preview-container" id="previewContainer"></div>
            {% for image in part.images %}
            <div class="dz-preview dz-processing dz-image-preview dz-complete">
                <div class="dz-image">
                    <img data-dz-thumbnail src="{{ url_for('static', filename='images/' + image.filename) }}">
                </div>
                <div class="dz-details">
                    <div class="dz-filename"><span data-dz-name>{{ image.filename }}</span></div>
                </div>
                <a class="dz-remove" href="javascript:undefined;" data-image-id="{{ image.id }}">Remove</a>
            </div>
            {% endfor %}
        </div>
    </div>

    <div class="progress-bar" style="height: 13px; background: #e0d3af;">
        <div id="upload-progress" style="height: 100%; width: 0%; background: #8b7355;"></div>
    </div>

    <textarea name="description" maxlength="1024" placeholder="Description">{{ part.description }}</textarea>
  
    <!-- Pre-populated Dropdowns -->
    <select name="brand_id">
        <option value="">Select Brand</option>
        {% for brand in brands %}
        <option value="{{ brand.id }}" {% if part.brand_id == brand.id %}selected{% endif %}>{{ brand.name }}</option>
        {% endfor %}
    </select>
    
    <select name="part_type_id" required>
        <option value="">Select Type</option>
        {% for type in part_types %}
        <option value="{{ type.id }}" {% if part.part_type_id == type.id %}selected{% endif %}>{{ type.name }}</option>
        {% endfor %}
    </select>
    
    <!-- Location Selector -->
    <select name="location_id" id="location_id" required>
        <option value="">Select Location</option>
        {% for location in locations %}
        <option value="{{ location.id }}" {% if part.location_id == location.id %}selected{% endif %}>{{ location.name }}</option>
        {% endfor %}
    </select>

    <!-- Box and Position -->
    <div class="form-row">
        <div class="form-group">
            <input type="text" id="box" name="box" maxlength="20" 
                placeholder="Box / container number" value="{{ part.box }}">
        </div>
        <div class="form-group">
            <input type="text" id="position" name="position" maxlength="50"
                placeholder="Location in the store" value="{{ part.position }}">
        </div>
    </div>

    <!-- Tag Manager -->
    <div class="tag-manager">
      <input type="text" id="tag-input" placeholder="Add tag (max 8)" maxlength="100">
      <div id="selected-tags">
        {% for tag in part.tags %}
        <span class="tag-pill" data-tag-id="{{ tag.id }}">{{ tag.name }} √ó</span>
        {% endfor %}
      </div>
      <div id="existing-tags">
        <!-- Popular tags appear here as clickable pills -->
      </div>
    </div>
    
    <div class="form-footer">
        <button type="submit" class="vintage-button">
          <span class="button-text">Update Part</span>
          <span class="button-icon">‚ö°</span>
        </button>
        <button type="button" id="delete-part" class="vintage-button delete-button">
          <span class="button-text">Delete Part</span>
          <span class="button-icon">üóëÔ∏è</span>
        </button>
    </div>

</form>

{% block scripts %}
<!-- Load Dropzone.js -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/dropzone.min.css') }}">
<script src="{{ url_for('static', filename='js/dropzone.min.js') }}"></script>
<script>Dropzone.autoDiscover = false;</script>
<script src="{{ url_for('static', filename='js/part_editor.js') }}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize Dropzone
    var myDropzone = new Dropzone("#dropzone", {
        url: "/parts/upload", // Your upload endpoint
        paramName: "file",
        maxFilesize: 16, // MB
        maxFiles: 8,
        acceptedFiles: "image/*",
        addRemoveLinks: true,
        autoProcessQueue: false,
        dictDefaultMessage: "",
        dictRemoveFile: "Remove",
        thumbnailWidth: 120,  // Thumbnail width in px
        thumbnailHeight: 120, // Thumbnail height in px
        init: function() {
            // Add existing images as mock files
            {% for image in part.images %}
            var mockFile = {
                name: "{{ image.filename }}",
                size: {{ image.file_size }},
                accepted: true,
                url: "{{ url_for('static', filename='images/' + image.filename) }}",
                imageId: "{{ image.id }}" // Custom attribute to track DB ID
            };
            
            // Call the default addedfile event
            this.emit("addedfile", mockFile);
            
            // And show the thumbnail
            this.emit("thumbnail", mockFile, mockFile.url);
            
            // Make sure the file is not clickable (not downloadable)
            mockFile.previewElement.classList.add("dz-success");
            mockFile.previewElement.classList.add("dz-complete");
            
            // Add custom remove button handler
            var removeButton = mockFile.previewElement.querySelector(".dz-remove");
            removeButton.addEventListener("click", function(e) {
                e.preventDefault();
                e.stopPropagation();
                
                if (confirm("Remove this image?")) {
                    // If it's an existing image (has imageId), we need to mark it for deletion
                    if (mockFile.imageId) {
                        // Add to a hidden field or array to track deletions
                        var deletedImages = document.getElementById('deleted-images') || 
                            document.createElement('input');
                        deletedImages.type = 'hidden';
                        deletedImages.id = 'deleted-images';
                        deletedImages.name = 'deleted_images';
                        deletedImages.value = (deletedImages.value ? deletedImages.value + ',' : '') + mockFile.imageId;
                        document.getElementById('part-form').appendChild(deletedImages);
                    }
                    
                    // Remove the file from Dropzone
                    myDropzone.removeFile(mockFile);
                }
            });
            {% endfor %}
        }
    });

    // Rest of your edit mode initialization...
    window.partEditMode = true;
    window.partId = {{ part.id }};
    
    // Delete button handler
    document.getElementById('delete-part').addEventListener('click', function() {
        if (confirm('Are you sure you want to delete this part?')) {
            fetch('/parts/delete/{{ part.id }}', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('input[name="csrf_token"]').value,
                    'Content-Type': 'application/json'
                }
            }).then(response => {
                if (response.ok) {
                    window.location.href = '/parts';
                }
            });
        }
    });
});
</script>
{% endblock %}
{% endblock %}